@using ComplectGroup.Web.Models
@model ComplectationBrowseViewModel
@{
    ViewData["Title"] = "–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏";
}

<div class="container mt-4">
    <h1>@ViewData["Title"]</h1>

    <div class="mb-3">
        <a asp-action="Index" class="btn btn-primary">–°–ø–∏—Å–æ–∫</a>
        <a asp-action="Import" class="btn btn-success me-2">üìä Excel</a>
        <a asp-action="ReportByDates" class="btn btn-primary">–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</a>
        <a asp-action="Browse" class="btn btn-secondary">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
    </div>

    <!-- === –ö–Ω–æ–ø–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ === -->
    <div class="mb-3">
        @if (Model.SelectedComplectation != null)
        {
            <form method="get" action="@Url.Action("Browse")" style="display: inline;">
                <input type="hidden" name="id" value="@Model.SelectedComplectation.Id" />
                @if (Model.ShowOnlyDeficit)
                {
                    <input type="hidden" name="showOnlyDeficit" value="false" />
                    <button type="submit" class="btn btn-warning">
                        ‚úì –¢–æ–ª—å–∫–æ —Å –¥–µ—Ñ–∏—Ü–∏—Ç–æ–º (–æ—Ç–∫–ª—é—á–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä)
                    </button>
                }
                else
                {
                    <input type="hidden" name="showOnlyDeficit" value="true" />
                    <button type="submit" class="btn btn-outline-warning">
                        –¢–æ–ª—å–∫–æ —Å –¥–µ—Ñ–∏—Ü–∏—Ç–æ–º
                    </button>
                }
            </form>
        }
    </div>

    <!-- === –í—ã–±–æ—Ä –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏ === -->
    <div class="mb-3">
        <label class="form-label" for="complectationSelect"><strong>–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è</strong></label>
        <form method="get" action="@Url.Action("Browse")" style="display: flex; gap: 10px; align-items: flex-end;">
            <div style="flex: 1;">
                <select class="form-select" id="complectationSelect" name="id" onchange="this.form.submit()">
                    @{
                        var selectedId = Model.SelectedComplectation?.Id;
                    }
                    @foreach (var c in Model.Complectations)
                    {
                        if (selectedId == c.Id)
                        {
                            <option value="@c.Id" selected>
                                @c.Number - @c.Customer (@c.ShippingDate.ToString("dd.MM.yyyy"))
                            </option>
                        }
                        else
                        {
                            <option value="@c.Id">
                                @c.Number - @c.Customer (@c.ShippingDate.ToString("dd.MM.yyyy"))
                            </option>
                        }
                    }
                </select>
            </div>
            <!-- –ü–µ—Ä–µ–¥–∞—ë–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –∫–∞–∫ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ -->
            <input type="hidden" name="showOnlyDeficit" value="@Model.ShowOnlyDeficit.ToString().ToLower()" />
        </form>
        
        <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ -->
        <div class="mt-2 text-muted small">
            –ü–æ–∫–∞–∑–∞–Ω–æ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–π: @Model.Complectations.Count, 
            –ø–µ—Ä–≤–∞—è: @Model.Complectations.FirstOrDefault()?.Number, 
            –ø–æ—Å–ª–µ–¥–Ω—è—è: @Model.Complectations.LastOrDefault()?.Number
        </div>
    </div>

    @if (Model.SelectedComplectation != null)
    {
        <h3>@Model.SelectedComplectation.Number - @Model.SelectedComplectation.Customer</h3>
        <p class="text-muted">
            –î–∞—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏: @Model.SelectedComplectation.ShippingDate.ToString("dd.MM.yyyy"),
            –ú–µ–Ω–µ–¥–∂–µ—Ä: @Model.SelectedComplectation.Manager
        </p>

        @if (Model.PositionDetails.Any())
        {
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>–†–∞–∑–¥–µ–ª</th>
                            <th>–î–µ—Ç–∞–ª—å</th>
                            <th class="text-center">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th class="text-center bg-success text-white">–ù–∞ —Å–∫–ª–∞–¥–µ</th>
                            <th class="text-center bg-info text-white">–û—Ç–≥—Ä—É–∂–µ–Ω–æ</th>
                            <th class="text-center bg-warning text-dark">–ù–∞–¥–æ –æ—Ç–≥—Ä—É–∑–∏—Ç—å</th>
                            <th class="text-center bg-danger text-white">–î–µ—Ñ–∏—Ü–∏—Ç</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in Model.PositionDetails)
                        {
                            string deficitClass = "text-center ";
                            if (row.Deficit == 0)
                                deficitClass += "bg-success text-white";
                            else if (row.Deficit > 0)
                                deficitClass += "bg-danger text-white";
                            else
                                deficitClass += "bg-info text-white";

                            string warehouseClass = "text-center ";
                            if (row.WarehouseQuantity == 0)
                                warehouseClass += "bg-danger text-white";
                            else if (row.WarehouseQuantity < row.RemainingToShip)
                                warehouseClass += "bg-warning text-dark";
                            else
                                warehouseClass += "bg-success text-white";

                            <tr>
                                <td>@row.Chapter</td>
                                <td>@row.PartName</td>
                                <td class="text-center"><strong>@row.RequiredQuantity</strong></td>
                                <td class="@warehouseClass"><strong>@row.WarehouseQuantity</strong></td>
                                <td class="text-center bg-info text-white"><strong>@row.ShippedQuantity</strong></td>
                                <td class="text-center bg-warning text-dark"><strong>@row.RemainingToShip</strong></td>
                                <td class="@deficitClass"><strong>@row.Deficit</strong></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
            <div class="mt-2">
                @if (Model.ShowOnlyDeficit)
                {
                    <div class="alert alert-info">
                        <i class="bi bi-filter"></i> –ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–∏ —Å –¥–µ—Ñ–∏—Ü–∏—Ç–æ–º.
                        –í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π: @Model.PositionDetails.Count
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-info">
                @if (Model.ShowOnlyDeficit)
                {
                    <p><i class="bi bi-emoji-frown"></i> –ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π —Å –¥–µ—Ñ–∏—Ü–∏—Ç–æ–º –≤ —ç—Ç–æ–π –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏.</p>
                }
                else
                {
                    <p><i class="bi bi-inbox"></i> –ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π –≤ —ç—Ç–æ–π –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏.</p>
                }
            </div>
        }
    }
    else
    {
        <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
    }
</div>

<!-- –î–æ–±–∞–≤–ª—è–µ–º –≤ Browse.cshtml –ø–æ—Å–ª–µ —Ç–∞–±–ª–∏—Ü—ã -->
@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const select = document.getElementById('complectationSelect');
            if (!select) return;
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ option –≤ –º–∞—Å—Å–∏–≤
            const options = Array.from(select.options);
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º option –ø–æ —Ç–µ–∫—Å—Ç—É, –∏–∑–≤–ª–µ–∫–∞—è —á–∏—Å–ª–æ–≤—É—é —á–∞—Å—Ç—å
            options.sort((a, b) => {
                const numA = extractNumber(a.text);
                const numB = extractNumber(b.text);
                return numA - numB;
            });
            
            // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ option
            select.innerHTML = '';
            options.forEach(option => {
                select.appendChild(option);
            });
            
            function extractNumber(text) {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–µ—Ä–≤—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ü–∏—Ñ—Ä
                const match = text.match(/\d+/);
                return match ? parseInt(match[0]) : Infinity;
            }
        });
    </script>
}