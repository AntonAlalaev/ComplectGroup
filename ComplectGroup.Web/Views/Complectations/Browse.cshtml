@using ComplectGroup.Web.Models
@model ComplectationBrowseViewModel
@{
    ViewData["Title"] = "–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏";
}


<div class="container mt-4">
    <h1>@ViewData["Title"]</h1>


    <div class="mb-3">
        <a asp-action="Index" class="btn btn-primary">–°–ø–∏—Å–æ–∫</a>
        <a asp-action="Import" class="btn btn-success me-2">üìä Excel</a>
        <a asp-action="ReportByDates" class="btn btn-primary">–û—Ç—á—ë—Ç</a>
        <a asp-action="Browse" class="btn btn-secondary">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
    </div>


    <!-- === –ö–Ω–æ–ø–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ === -->
    <div class="mb-3">
        <!-- –û–¢–õ–ê–î–ö–ê -->
        <div style="background: #f0f0f0; padding: 10px; margin-bottom: 10px; font-size: 12px;">
            <strong>DEBUG:</strong><br/>
            SelectedComplectation: @Model.SelectedComplectation?.Id<br/>
            ShowOnlyDeficit: @Model.ShowOnlyDeficit<br/>
            Filter URL: @Url.Action("Browse", new { id = Model.SelectedComplectation?.Id, showOnlyDeficit = !Model.ShowOnlyDeficit })
        </div>

        @if (Model.SelectedComplectation != null)
        {
            @if (Model.ShowOnlyDeficit)
            {
                <a href="@Url.Action("Browse", new { id = Model.SelectedComplectation.Id, showOnlyDeficit = false })" 
                class="btn btn-warning">
                    ‚úì –¢–æ–ª—å–∫–æ —Å –¥–µ—Ñ–∏—Ü–∏—Ç–æ–º (–æ—Ç–∫–ª—é—á–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä)
                </a>
            }
            else
            {
                <a href="@Url.Action("Browse", new { id = Model.SelectedComplectation.Id, showOnlyDeficit = true })" 
                class="btn btn-outline-warning">
                    –¢–æ–ª—å–∫–æ —Å –¥–µ—Ñ–∏—Ü–∏—Ç–æ–º
                </a>
            }
        }
    </div>

    <!-- === –í—ã–±–æ—Ä –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏ === -->
    <div class="mb-3">
        <label class="form-label" for="complectationSelect"><strong>–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è</strong></label>
        <form method="get" action="@Url.Action("Browse")" style="display: flex; gap: 10px; align-items: flex-end;">
            <div style="flex: 1;">
                <select class="form-select" id="complectationSelect" name="id" onchange="this.form.submit()">
                    @{
                        var selectedId = Model.SelectedComplectation?.Id;
                    }
                    @foreach (var c in Model.Complectations)
                    {
                        if (selectedId == c.Id)
                        {
                            <option value="@c.Id" selected>
                                @c.Number - @c.Customer (@c.ShippingDate.ToString("dd.MM.yyyy"))
                            </option>
                        }
                        else
                        {
                            <option value="@c.Id">
                                @c.Number - @c.Customer (@c.ShippingDate.ToString("dd.MM.yyyy"))
                            </option>
                        }
                    }
                </select>
            </div>
            <!-- –ü–µ—Ä–µ–¥–∞—ë–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –∫–∞–∫ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ -->
            <input type="hidden" name="showOnlyDeficit" value="@Model.ShowOnlyDeficit.ToString().ToLower()" />
        </form>
    </div>





    @if (Model.SelectedComplectation != null)
    {
        <h3>@Model.SelectedComplectation.Number</h3>

        @if (Model.PositionDetails.Any())
        {
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>–†–∞–∑–¥–µ–ª</th>
                            <th>–î–µ—Ç–∞–ª—å</th>
                            <th class="text-center">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th class="text-center bg-success text-white">–ù–∞ —Å–∫–ª–∞–¥–µ</th>
                            <th class="text-center bg-info text-white">–û—Ç–≥—Ä—É–∂–µ–Ω–æ</th>
                            <th class="text-center bg-warning text-dark">–ù–∞–¥–æ –æ—Ç–≥—Ä—É–∑–∏—Ç—å</th>
                            <th class="text-center bg-danger text-white">–î–µ—Ñ–∏—Ü–∏—Ç</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in Model.PositionDetails)
                        {
                            string deficitClass = "text-center ";
                            if (row.Deficit == 0)
                                deficitClass += "bg-success text-white";
                            else if (row.Deficit > 0)
                                deficitClass += "bg-danger text-white";
                            else
                                deficitClass += "bg-info text-white";

                            string warehouseClass = "text-center ";
                            if (row.WarehouseQuantity == 0)
                                warehouseClass += "bg-danger text-white";
                            else if (row.WarehouseQuantity < row.RemainingToShip)
                                warehouseClass += "bg-warning text-dark";
                            else
                                warehouseClass += "bg-success text-white";

                            <tr>
                                <td>@row.Chapter</td>
                                <td>@row.PartName</td>
                                <td class="text-center"><strong>@row.RequiredQuantity</strong></td>
                                <td class="@warehouseClass"><strong>@row.WarehouseQuantity</strong></td>
                                <td class="text-center bg-info text-white"><strong>@row.ShippedQuantity</strong></td>
                                <td class="text-center bg-warning text-dark"><strong>@row.RemainingToShip</strong></td>
                                <td class="@deficitClass"><strong>@row.Deficit</strong></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info">
                @if (Model.ShowOnlyDeficit)
                {
                    <p>–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π —Å –¥–µ—Ñ–∏—Ü–∏—Ç–æ–º</p>
                }
                else
                {
                    <p>–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π –≤ —ç—Ç–æ–π –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏</p>
                }
            </div>
        }
    }
    else
    {
        <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
    }
</div>
