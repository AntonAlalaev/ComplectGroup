@using ComplectGroup.Web.Models
@model PartsReportViewModel

@{
    ViewData["Title"] = "Отчёт по деталям";
}

<h1>@ViewData["Title"]</h1>

<!-- Фильтры -->
<form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
        <label for="from" class="form-label">От даты</label>
        <input type="date" class="form-control" id="from" name="from" 
               value="@(Model.From?.ToString("yyyy-MM-dd"))" />
    </div>
    <div class="col-md-3">
        <label for="to" class="form-label">До даты</label>
        <input type="date" class="form-control" id="to" name="to" 
               value="@(Model.To?.ToString("yyyy-MM-dd"))" />
    </div>
    <div class="col-md-3">
        <label for="chapter" class="form-label">Раздел</label>
        <select class="form-select" id="chapter" name="chapter">
            @if (Model.SelectedChapter == "*")
            {
                <option value="*" selected>Все разделы</option>
            }
            else
            {
                <option value="*">Все разделы</option>
            }
            
            @foreach (var ch in Model.AvailableChapters)
            {
                if (Model.SelectedChapter == ch)
                {
                    <option value="@ch" selected>@ch</option>
                }
                else
                {
                    <option value="@ch">@ch</option>
                }
            }
        </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Применить фильтр</button>
    </div>
</form>

<!-- Таблица отчёта -->
@if (Model.Rows.Any())
{
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="table-light">
                <tr>
                    <th>Раздел</th>
                    <th>Деталь</th>
                    <th>Итого</th>
                    <th class="text-center">На складе</th>
                    <th class="text-center">Дефицит</th>
                    @foreach (var col in Model.ComplectationColumns)
                    {
                        <th class="text-center">
                            <small>@col.Number</small><br/>
                            <small>@col.ShippingDate.ToString("dd.MM.yyyy")</small><br/>
                            <small>@col.TotalWeight.ToString("F0") кг / @col.TotalVolume.ToString("F2") м³</small>
                        </th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var row in Model.Rows)
                {
                    <tr>
                        <td>@row.Chapter</td>
                        <td>@row.PartName</td>
                        <td class="text-center fw-bold">@row.TotalQuantity</td>
                        
                        @* На складе - условная раскраска *@
                        @{
                            string warehouseClass = "text-center text-white ";
                            if (row.WarehouseQuantity == 0)
                            {
                                warehouseClass += "bg-danger"; // Красный если 0
                            }
                            else if (row.WarehouseQuantity < row.DeficitQuantity)
                            {
                                warehouseClass += "bg-warning"; // Желтый если больше 0 но меньше дефицита
                            }
                            else
                            {
                                warehouseClass += "bg-success"; // Зеленый если больше дефицита
                            }
                        }
                        <td class="@warehouseClass">
                            <strong>@row.WarehouseQuantity</strong>
                        </td>
                        
                        @* Дефицит - условная раскраска *@
                        @{
                            string deficitClass = "text-center text-white ";
                            if (row.DeficitQuantity > 0)
                            {
                                deficitClass += "bg-danger"; // Красный если больше 0
                            }
                            else
                            {
                                deficitClass += "bg-success"; // Зеленый если 0
                            }
                        }
                        <td class="@deficitClass">
                            <strong>@row.DeficitQuantity</strong>
                        </td>
                        
                        @foreach (var col in Model.ComplectationColumns)
                        {
                            var required = row.QuantitiesByComplectation.TryGetValue(col.ComplectationId, out var rq) ? rq : 0;
                            var shipped = row.ShippedByComplectation.TryGetValue(col.ComplectationId, out var sh) ? sh : 0;
                            var remaining = Math.Max(0, required - shipped);
                            
                            <td class="text-center">@(remaining == 0 ? "" : remaining.ToString())</td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info">
        В указанном диапазоне нет ни одной комплектации.
    </div>
}
