@using ComplectGroup.Web.Models
@model PartsReportViewModel

@{
    ViewData["Title"] = "–û—Ç—á—ë—Ç –ø–æ –¥–µ—Ç–∞–ª—è–º";
}

<h1>@ViewData["Title"]</h1>

    <div class="mb-3">
        <a asp-action="Index" class="btn btn-primary">–°–ø–∏—Å–æ–∫</a>
        <a asp-action="Import" class="btn btn-success me-2">üìä Excel</a>
        <a asp-action="ReportByDates" class="btn btn-primary">–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</a>
        <a asp-action="Browse" class="btn btn-secondary">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
    </div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
        <label for="from" class="form-label">–û—Ç –¥–∞—Ç—ã</label>
        <input type="date" class="form-control" id="from" name="from" 
               value="@(Model.From?.ToString("yyyy-MM-dd"))" />
    </div>
    <div class="col-md-3">
        <label for="to" class="form-label">–î–æ –¥–∞—Ç—ã</label>
        <input type="date" class="form-control" id="to" name="to" 
               value="@(Model.To?.ToString("yyyy-MM-dd"))" />
    </div>
    <div class="col-md-3">
        <label for="chapter" class="form-label">–†–∞–∑–¥–µ–ª</label>
        <select class="form-select" id="chapter" name="chapter">
            @if (Model.SelectedChapter == "*")
            {
                <option value="*" selected>–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã</option>
            }
            else
            {
                <option value="*">–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã</option>
            }
            
            @foreach (var ch in Model.AvailableChapters)
            {
                if (Model.SelectedChapter == ch)
                {
                    <option value="@ch" selected>@ch</option>
                }
                else
                {
                    <option value="@ch">@ch</option>
                }
            }
        </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
    </div>
</form>

<!-- –¢–∞–±–ª–∏—Ü–∞ –æ—Ç—á—ë—Ç–∞ -->
@if (Model.Rows.Any())
{
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="table-light">
                <tr>
                    <th>–†–∞–∑–¥–µ–ª</th>
                    <th>–î–µ—Ç–∞–ª—å</th>
                    <th>–ò—Ç–æ–≥–æ</th>
                    <th class="text-center">–ù–∞ —Å–∫–ª–∞–¥–µ</th>
                    <th class="text-center">–î–µ—Ñ–∏—Ü–∏—Ç</th>
                    @foreach (var col in Model.ComplectationColumns)
                    {
                        <th class="text-center">
                            <small>@col.Number</small><br/>
                            <small>@col.ShippingDate.ToString("dd.MM.yyyy")</small><br/>
                            <small>@col.TotalWeight.ToString("F0") –∫–≥ / @col.TotalVolume.ToString("F2") –º¬≥</small>
                        </th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var row in Model.Rows)
                {
                    <tr>
                        <td>@row.Chapter</td>
                        <td>@row.PartName</td>
                        <td class="text-center fw-bold">@row.TotalQuantity</td>
                        
                        @* –ù–∞ —Å–∫–ª–∞–¥–µ - —É—Å–ª–æ–≤–Ω–∞—è —Ä–∞—Å–∫—Ä–∞—Å–∫–∞ *@
                        @{
                            string warehouseClass = "text-center text-white ";
                            if (row.WarehouseQuantity == 0)
                            {
                                warehouseClass += "bg-danger"; // –ö—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ 0
                            }
                            else if (row.WarehouseQuantity < row.DeficitQuantity)
                            {
                                warehouseClass += "bg-warning"; // –ñ–µ–ª—Ç—ã–π –µ—Å–ª–∏ –±–æ–ª—å—à–µ 0 –Ω–æ –º–µ–Ω—å—à–µ –¥–µ—Ñ–∏—Ü–∏—Ç–∞
                            }
                            else
                            {
                                warehouseClass += "bg-success"; // –ó–µ–ª–µ–Ω—ã–π –µ—Å–ª–∏ –±–æ–ª—å—à–µ –¥–µ—Ñ–∏—Ü–∏—Ç–∞
                            }
                        }
                        <td class="@warehouseClass">
                            <strong>@row.WarehouseQuantity</strong>
                        </td>
                        
                        @* –î–µ—Ñ–∏—Ü–∏—Ç - —É—Å–ª–æ–≤–Ω–∞—è —Ä–∞—Å–∫—Ä–∞—Å–∫–∞ *@
                        @{
                            string deficitClass = "text-center text-white ";
                            if (row.DeficitQuantity > 0)
                            {
                                deficitClass += "bg-danger"; // –ö—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ –±–æ–ª—å—à–µ 0
                            }
                            else
                            {
                                deficitClass += "bg-success"; // –ó–µ–ª–µ–Ω—ã–π –µ—Å–ª–∏ 0
                            }
                        }
                        <td class="@deficitClass">
                            <strong>@row.DeficitQuantity</strong>
                        </td>
                        
                        @foreach (var col in Model.ComplectationColumns)
                        {
                            var required = row.QuantitiesByComplectation.TryGetValue(col.ComplectationId, out var rq) ? rq : 0;
                            var shipped = row.ShippedByComplectation.TryGetValue(col.ComplectationId, out var sh) ? sh : 0;
                            var remaining = Math.Max(0, required - shipped);
                            
                            <td class="text-center">@(remaining == 0 ? "" : remaining.ToString())</td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info">
        –í —É–∫–∞–∑–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏.
    </div>
}
