<!-- ComplectGroup.Web/Views/Complectations/ReportByDates.cshtml -->
@using ComplectGroup.Web.Models
@model PartsReportViewModel

@{
    ViewData["Title"] = "–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–π";
}

<h1>@ViewData["Title"]</h1>

<div class="mb-3">
    <a asp-action="Index" class="btn btn-primary">–°–ø–∏—Å–æ–∫</a>
    <a asp-action="Import" class="btn btn-success me-2">üìä Excel</a>
    <a asp-action="ReportByDates" class="btn btn-primary">–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</a>
    <a asp-action="Browse" class="btn btn-secondary">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
        <label for="from" class="form-label">–û—Ç –¥–∞—Ç—ã</label>
        <input type="date" class="form-control" id="from" name="from" 
               value="@(Model.From?.ToString("yyyy-MM-dd"))" />
    </div>
    <div class="col-md-3">
        <label for="to" class="form-label">–î–æ –¥–∞—Ç—ã</label>
        <input type="date" class="form-control" id="to" name="to" 
               value="@(Model.To?.ToString("yyyy-MM-dd"))" />
    </div>
    <div class="col-md-3">
        <label for="chapter" class="form-label">–†–∞–∑–¥–µ–ª</label>
        <select class="form-select" id="chapter" name="chapter">
            @if (Model.SelectedChapter == "*")
            {
                <option value="*" selected>–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã</option>
            }
            else
            {
                <option value="*">–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã</option>
            }
            
            @foreach (var ch in Model.AvailableChapters)
            {
                if (Model.SelectedChapter == ch)
                {
                    <option value="@ch" selected>@ch</option>
                }
                else
                {
                    <option value="@ch">@ch</option>
                }
            }
        </select>
    </div>
    <div class="col-md-3">
        <!-- –î–û–ë–ê–í–õ–Ø–ï–ú –ß–ï–ö–ë–û–ö–° –î–õ–Ø –§–ò–õ–¨–¢–†–ê –ü–û –î–ï–§–ò–¶–ò–¢–£ -->
        <div class="form-check mt-4">
            <input class="form-check-input" type="checkbox" id="onlyDeficit" name="onlyDeficit" 
                   value="true" @(Model.OnlyDeficit ? "checked" : "") />
            <input type="hidden" name="onlyDeficit" value="false" /> <!-- –î–ª—è false —Å–æ—Å—Ç–æ—è–Ω–∏—è -->
            <label class="form-check-label" for="onlyDeficit">
                –¢–æ–ª—å–∫–æ –¥–µ—Ç–∞–ª–∏ —Å –¥–µ—Ñ–∏—Ü–∏—Ç–æ–º
            </label>
        </div>
    </div>
    <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
    </div>
</form>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∏–ª—å—Ç—Ä–∞—Ö -->
@if (Model.OnlyDeficit)
{
    <div class="alert alert-info mb-3">
        <i class="bi bi-funnel"></i> –ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –¥–µ—Ç–∞–ª–∏ —Å –¥–µ—Ñ–∏—Ü–∏—Ç–æ–º (–≤—Å–µ–≥–æ: @Model.Rows.Count)
    </div>
}

<!-- –¢–∞–±–ª–∏—Ü–∞ –æ—Ç—á—ë—Ç–∞ -->
@if (Model.Rows.Any())
{
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="table-light">
                <tr>
                    <th>–†–∞–∑–¥–µ–ª</th>
                    <th>–î–µ—Ç–∞–ª—å</th>
                    <th>–ò—Ç–æ–≥–æ</th>
                    <th class="text-center">–ù–∞ —Å–∫–ª–∞–¥–µ</th>
                    <th class="text-center">–î–µ—Ñ–∏—Ü–∏—Ç</th>
                    @foreach (var col in Model.ComplectationColumns)
                    {
                        <th class="text-center">
                            <small>@col.Number</small><br/>
                            <small>@col.ShippingDate.ToString("dd.MM.yyyy")</small><br/>
                            <small>@col.TotalWeight.ToString("F0") –∫–≥ / @col.TotalVolume.ToString("F2") –º¬≥</small>
                        </th>
                    }
                </tr>
            </thead>

            <!-- ... —Ç–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã ... -->

            <tbody>
                @foreach (var row in Model.Rows)
                {
                    <tr>
                        <td>@row.Chapter</td>
                        <td>@row.PartName</td>
                        <td class="text-center fw-bold">@row.TotalQuantity</td>
                        
                        @* –ù–∞ —Å–∫–ª–∞–¥–µ - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å–∫—Ä–∞—Å–∫–∏ *@
                        @{
                            string warehouseClass = "text-center text-white ";
                            if (row.WarehouseQuantity == 0)
                            {
                                warehouseClass += "bg-danger"; // –ö—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ 0
                            }
                            else if (row.WarehouseQuantity < row.TotalQuantity) // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨
                            {
                                // –ñ–µ–ª—Ç—ã–π –µ—Å–ª–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ –º–µ–Ω—å—à–µ, —á–µ–º —Ç—Ä–µ–±—É–µ—Ç—Å—è (TotalQuantity)
                                // –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –¥–µ—Ñ–∏—Ü–∏—Ç = 0, –Ω–æ —Ç–æ–≥–¥–∞ –Ω–µ –ø–æ–ø–∞–¥–µ—Ç –≤ —Ñ–∏–ª—å—Ç—Ä
                                warehouseClass += "bg-warning";
                            }
                            else
                            {
                                warehouseClass += "bg-success"; // –ó–µ–ª–µ–Ω—ã–π –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥–µ
                            }
                        }
                        <td class="@warehouseClass">
                            <strong>@row.WarehouseQuantity</strong>
                        </td>
                        
                        @* –î–µ—Ñ–∏—Ü–∏—Ç - —É—Å–ª–æ–≤–Ω–∞—è —Ä–∞—Å–∫—Ä–∞—Å–∫–∞ *@
                        @{
                            string deficitClass = "text-center text-white ";
                            if (row.DeficitQuantity > 0)
                            {
                                deficitClass += "bg-danger"; // –ö—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ –±–æ–ª—å—à–µ 0
                            }
                            else
                            {
                                deficitClass += "bg-success"; // –ó–µ–ª–µ–Ω—ã–π –µ—Å–ª–∏ 0
                            }
                        }
                        <td class="@deficitClass">
                            <strong>@row.DeficitQuantity</strong>
                        </td>
                        
                        @foreach (var col in Model.ComplectationColumns)
                        {
                            var required = row.QuantitiesByComplectation.TryGetValue(col.ComplectationId, out var rq) ? rq : 0;
                            var shipped = row.ShippedByComplectation.TryGetValue(col.ComplectationId, out var sh) ? sh : 0;
                            var remaining = Math.Max(0, required - shipped);
                            
                            <td class="text-center">@(remaining == 0 ? "" : remaining.ToString())</td>
                        }
                    </tr>
                }
            </tbody>

            <!-- ... —Ç–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã ... -->
        </table>
    </div>
}
else
{
    <div class="alert alert-info">
        @if (Model.OnlyDeficit)
        {
            <p>–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π —Å –¥–µ—Ñ–∏—Ü–∏—Ç–æ–º –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ.</p>
        }
        else
        {
            <p>–í —É–∫–∞–∑–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏.</p>
        }
    </div>
}

@* –î–û–ë–ê–í–õ–Ø–ï–ú –°–ö–†–ò–ü–¢ –î–õ–Ø –ü–†–ê–í–ò–õ–¨–ù–û–ô –†–ê–ë–û–¢–´ –ß–ï–ö–ë–û–ö–°–ê *@
@section Scripts {
    <script>
        // –£–±–∏—Ä–∞–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ —á–µ–∫–±–æ–∫—Å –æ—Ç–º–µ—á–µ–Ω
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            const checkbox = document.getElementById('onlyDeficit');
            const hiddenInput = document.querySelector('input[name="onlyDeficit"][type="hidden"]');
            
            form.addEventListener('submit', function() {
                if (checkbox.checked) {
                    hiddenInput.disabled = true;
                }
            });
        });
    </script>
}