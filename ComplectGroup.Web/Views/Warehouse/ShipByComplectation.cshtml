@using ComplectGroup.Web.Models
@model ComplectationShippingViewModel
@{
    ViewData["Title"] = "Отгрузка по комплектации";
}

<h1>@ViewData["Title"]</h1>

<!-- Алерты -->
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Форма -->
<form method="post" id="shippingForm">
    @Html.AntiForgeryToken()

    <!-- Выбор комплектации -->
    <div class="mb-4">
        <label for="SelectedComplectationId" class="form-label"><strong>Комплектация</strong></label>
        <div class="row">
            <div class="col-md-6">
                <select class="form-select form-select-lg" id="SelectedComplectationId" name="SelectedComplectationId" 
                        onchange="loadComplectationPositions()">
                    <option value="">-- Выберите комплектацию --</option>
                    @foreach (var compl in Model.Complectations.OrderByDescending(c => c.ShippingDate))
                    {
                        <option value="@compl.Id" data-number="@compl.Number">@compl.Number - @compl.Customer (@compl.ShippingDate.ToString("dd.MM.yyyy"))</option>
                    }
                </select>
                <span class="text-danger">@Html.ValidationMessage("SelectedComplectationId")</span>
            </div>
        </div>
    </div>

    <!-- Таблица позиций -->
    <div id="lineItemsContainer" style="display: none;">
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Раздел</th>
                        <th>Деталь</th>
                        <th class="text-center">Требуемо</th>
                        <th class="text-center bg-info text-white">Отгружено</th>
                        <th class="text-center bg-warning text-dark">Осталось отгрузить</th>
                        <th class="text-center bg-success text-white">На складе</th>
                        <th class="text-center">Отгрузить</th>
                    </tr>
                </thead>
                <tbody id="lineItemsBody">
                    <!-- Заполнится JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Кнопки -->
    <div class="mt-4">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="fas fa-arrow-up"></i> Отгрузить
        </button>
        <a href="@Url.Action("Index", "Warehouse")" class="btn btn-secondary btn-lg">
            <i class="fas fa-times-circle"></i> Отмена
        </a>
    </div>
</form>

<!-- JavaScript -->
<script>
    // Функция для сортировки выпадающего списка комплектаций
    function sortComplectationOptions() {
        const complectationSelect = document.getElementById('SelectedComplectationId');
        if (!complectationSelect) return;
        
        // Сохраняем выбранное значение
        const selectedValue = complectationSelect.value;
        
        // Собираем все option в массив, кроме первого (заголовочного)
        const options = Array.from(complectationSelect.options);
        const firstOption = options[0]; // Заголовочный option
        const sortableOptions = options.slice(1); // Все остальные опции
        
        // Сортируем option по номеру комплектации
        sortableOptions.sort((a, b) => {
            // Получаем номера из data-number атрибута или из текста
            const numberA = extractComplectationNumber(a);
            const numberB = extractComplectationNumber(b);
            
            // Если оба номера - числа, сортируем численно
            if (!isNaN(numberA) && !isNaN(numberB)) {
                return parseInt(numberA) - parseInt(numberB);
            }
            
            // Иначе сортируем как строки
            return String(numberA).localeCompare(String(numberB));
        });
        
        // Очищаем select и добавляем опции в правильном порядке
        while (complectationSelect.firstChild) {
            complectationSelect.removeChild(complectationSelect.firstChild);
        }
        
        // Добавляем заголовочную опцию
        complectationSelect.appendChild(firstOption);
        
        // Добавляем отсортированные опции
        sortableOptions.forEach(option => {
            complectationSelect.appendChild(option);
        });
        
        // Восстанавливаем выбранное значение
        if (selectedValue) {
            complectationSelect.value = selectedValue;
        }
        
        console.log('Выпадающий список комплектаций отсортирован по номеру');
    }
    
    // Функция для извлечения номера комплектации из option
    function extractComplectationNumber(option) {
        // Сначала пытаемся получить из data-number атрибута
        if (option.dataset.number) {
            return option.dataset.number;
        }
        
        // Если нет, извлекаем из текста (часть до дефиса)
        const text = option.textContent;
        const dashIndex = text.indexOf(' - ');
        if (dashIndex > 0) {
            return text.substring(0, dashIndex).trim();
        }
        
        // Возвращаем весь текст, если дефиса нет
        return text;
    }

    function loadComplectationPositions() {
        const complectationId = document.getElementById('SelectedComplectationId').value;
        
        if (!complectationId) {
            document.getElementById('lineItemsContainer').style.display = 'none';
            return;
        }

        // AJAX
        fetch(`/Warehouse/GetComplectationShippingPositions/${complectationId}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                renderLineItems(data);
                document.getElementById('lineItemsContainer').style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ошибка загрузки позиций');
            });
    }

 
    function renderLineItems(items) {
        console.log('DEBUG: Items received:', items);
        const tbody = document.getElementById('lineItemsBody');
        tbody.innerHTML = '';

        items.forEach((item, index) => {
            console.log(`DEBUG: Item ${index}:`, item);

            // Определяем CSS класс для столбца "Осталось отгрузить"
            let remainingClass = 'text-center bg-warning text-dark';
            if (item.remainingToShip === 0) {
                remainingClass = 'text-center bg-success text-white';
            }

            // Определяем CSS класс для столбца "На складе"
            let warehouseClass = 'text-center ';
            if (item.warehouseQuantity === 0) {
                warehouseClass += 'bg-danger text-white';
            } else if (item.warehouseQuantity < item.remainingToShip) {
                warehouseClass += 'bg-warning text-dark';
            } else {
                warehouseClass += 'bg-success text-white';
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.chapter}</td>
                <td>${item.partName}</td>
                <td class="text-center"><strong>${item.requiredQuantity}</strong></td>
                <td class="text-center bg-info text-white"><strong>${item.alreadyShipped}</strong></td>
                <td class="${remainingClass}"><strong>${item.remainingToShip}</strong></td>
                <td class="${warehouseClass}"><strong>${item.warehouseQuantity}</strong></td>
                <td class="text-center">
                    <div class="d-flex align-items-center justify-content-center gap-2">
                        <input type="number" class="form-control form-control-sm shipping-quantity" 
                               id="shippingQty_${index}"
                               name="LineItems[${index}].ShippingQuantity" 
                               value="0"
                               min="0" max="9999" 
                               data-remaining="${item.remainingToShip}"
                               data-warehouse="${item.warehouseQuantity}"
                               style="width: 100px;" 
                               placeholder="0" />
                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                onclick="setOptimalQuantity(${index}, ${item.remainingToShip}, ${item.warehouseQuantity})" 
                                title="Заполнить оптимальным количеством">
                            <i class="fas fa-magic"></i>
                        </button>
                    </div>
                    <input type="hidden" name="LineItems[${index}].PositionId" value="${item.positionId}" />
                    <input type="hidden" name="LineItems[${index}].PartId" value="${item.partId}" />
                    <input type="hidden" name="LineItems[${index}].Chapter" value="${item.chapter}" />
                    <input type="hidden" name="LineItems[${index}].PartName" value="${item.partName}" />
                    <input type="hidden" name="LineItems[${index}].RequiredQuantity" value="${item.requiredQuantity}" />
                    <input type="hidden" name="LineItems[${index}].AlreadyShipped" value="${item.alreadyShipped}" />
                    <input type="hidden" name="LineItems[${index}].WarehouseQuantity" value="${item.warehouseQuantity}" />
                </td>
            `;
            tbody.appendChild(row);
        });

        // Добавляем обработчик для input'ов
        addInputValidation();
    }

    // Функция для установки оптимального количества
    function setOptimalQuantity(index, remainingToShip, warehouseQuantity) {
        const input = document.getElementById(`shippingQty_${index}`);
        
        if (!input) return;
        
        // Логика: если осталось отгрузить > 0 и на складе > 0
        let optimalQuantity = 0;
        
        if (remainingToShip > 0 && warehouseQuantity > 0) {
            // Берём минимальное из (осталось отгрузить, на складе)
            optimalQuantity = Math.min(remainingToShip, warehouseQuantity);
        }
        
        input.value = optimalQuantity;
        
        // Визуальная индикация изменения
        input.classList.add('bg-light');
        setTimeout(() => input.classList.remove('bg-light'), 500);
        
        console.log(`Установлено оптимальное количество: ${optimalQuantity} (осталось: ${remainingToShip}, на складе: ${warehouseQuantity})`);
    }




    function addInputValidation() {
        const inputs = document.querySelectorAll('.shipping-quantity');
        
        inputs.forEach((input, index) => {
            input.addEventListener('change', function(e) {
                const quantity = parseInt(this.value) || 0;
                const remaining = parseInt(this.dataset.remaining);
                const warehouse = parseInt(this.dataset.warehouse);

                // Проверка: если введено 0, ничего не делаем
                if (quantity === 0) {
                    return;
                }

                // Проверка 1: не больше, чем осталось отгрузить
                if (quantity > remaining) {
                    if (!confirm(`Вы хотите отгрузить ${quantity} шт., а требуется только ${remaining} шт.?\n\nВы уверены?`)) {
                        this.value = 0;
                        e.preventDefault();
                        return;
                    }
                }

                // Проверка 2: не больше, чем на складе
                if (quantity > warehouse) {
                    alert(`Ошибка: на складе только ${warehouse} шт., а вы пытаетесь отгрузить ${quantity} шт.!`);
                    this.value = 0;
                    return;
                }
                
                // Проверка 3: если осталось отгрузить 0, нельзя отгружать
                if (remaining === 0 && quantity > 0) {
                    alert('Нельзя отгрузить эту позицию, так как она уже полностью отгружена!');
                    this.value = 0;
                    return;
                }
                
                // Проверка 4: если на складе 0, нельзя отгружать
                if (warehouse === 0 && quantity > 0) {
                    alert('Нельзя отгрузить эту позицию, так как на складе нет деталей!');
                    this.value = 0;
                    return;
                }
            });
        });
    }

    // Обработчик submit формы
    document.getElementById('shippingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const inputs = document.querySelectorAll('.shipping-quantity');
        let hasValidData = false;

        inputs.forEach(input => {
            const quantity = parseInt(input.value) || 0;
            if (quantity > 0) {
                hasValidData = true;
            }
        });

        if (!hasValidData) {
            alert('Укажите количество хотя бы для одной позиции!');
            return;
        }

        this.submit();
    });
    
    // Вызываем сортировку при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        sortComplectationOptions();
    });
</script>

<style>
    .form-select-lg {
        padding: 0.5rem 1rem;
        font-size: 1.1rem;
    }

    .table-responsive {
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .table {
        margin-bottom: 0;
    }

    input[type="number"] {
        text-align: center;
        font-weight: bold;
    }
    
    .shipping-quantity:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    /* Стили для кнопки "Заполнить оптимальным" */
    .btn-outline-primary {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .btn-outline-primary:hover {
        background-color: #0d6efd;
        color: white;
    }

    /* Анимация подсветки */
    @@keyframes highlight {
        0% { background-color: #f8f9fa; }
        50% { background-color: #e9ecef; }
        100% { background-color: #f8f9fa; }
    }

    .bg-light {
        animation: highlight 0.5s ease;
    }
</style>