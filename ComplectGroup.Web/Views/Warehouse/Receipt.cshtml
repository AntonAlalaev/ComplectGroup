@using ComplectGroup.Web.Models
@model ReceiptViewModel

@{
    ViewData["Title"] = "–ü—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞";
}

<div class="container mt-4" style="max-width: 600px;">
    <div class="card">
        <div class="card-header bg-success text-white">
            <h4>üì• –ü—Ä–∏—Ö–æ–¥–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥</h4>
        </div>
        <div class="card-body">
            <form asp-action="Receipt" method="post" id="receiptForm">
                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="alert alert-danger">
                        <div asp-validation-summary="All"></div>
                    </div>
                }

                <div class="mb-3">
                    <label asp-for="PartId" class="form-label">–î–µ—Ç–∞–ª—å</label>
                    <select asp-for="PartId" class="form-select" required>
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å --</option>
                        @foreach (var part in Model.Parts)
                        {
                            <option value="@part.Id">
                                [@part.Chapter.Name] @part.Name
                            </option>
                        }
                    </select>
                    <span asp-validation-for="PartId" class="invalid-feedback"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Quantity" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç)</label>
                    <input asp-for="Quantity" type="number" class="form-control" min="1" required />
                    <span asp-validation-for="Quantity" class="invalid-feedback"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Notes" class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                    <textarea asp-for="Notes" class="form-control" rows="3" 
                              placeholder="–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞, –ø–æ—Å—Ç–∞–≤—â–∏–∫, –∏ —Ç.–¥." id="notesField"></textarea>
                    <span asp-validation-for="Notes" class="invalid-feedback"></span>
                    <div class="form-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
                </div>

                <div class="mb-3">
                    <label asp-for="ReceiptDate" class="form-label">–î–∞—Ç–∞ –ø—Ä–∏—ë–º–∫–∏</label>
                    <input asp-for="ReceiptDate" type="datetime-local" class="form-control" />
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success btn-lg" id="submitBtn">–ü—Ä–∏–Ω—è—Ç—å —Ç–æ–≤–∞—Ä</button>
                    <a asp-action="Index" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
<div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notesModalLabel">–ü–æ–ª–µ "–ü—Ä–∏–º–µ—á–∞–Ω–∏—è" –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>–í—ã —Ö–æ—Ç–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–µ "–ü—Ä–∏–º–µ—á–∞–Ω–∏—è" –∑–Ω–∞—á–µ–Ω–∏–µ–º <strong>"–ü—Ä–∏—Ö–æ–¥ —Å —É–ø–∞–∫–æ–≤–∫–∏"</strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn" data-bs-dismiss="modal">–ù–µ—Ç</button>
                <button type="button" class="btn btn-primary" id="confirmBtn">–î–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('receiptForm');
            const notesField = document.getElementById('notesField');
            const submitBtn = document.getElementById('submitBtn');
            const notesModal = new bootstrap.Modal(document.getElementById('notesModal'));
            
            let shouldSubmit = false;
            
            form.addEventListener('submit', function(event) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–æ—Ä–º—É (–ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ)
                if (shouldSubmit) {
                    shouldSubmit = false;
                    return true; // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è Notes, —É–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã
                const notesValue = notesField.value.trim();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–æ—Ä–º—ã
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                    form.classList.add('was-validated');
                    return false;
                }
                
                // –ï—Å–ª–∏ –ø–æ–ª–µ Notes –ø—É—Å—Ç–æ–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                if (notesValue === '') {
                    event.preventDefault();
                    notesModal.show();
                    return false;
                }
                
                // –ï—Å–ª–∏ –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –∫–∞–∫ –æ–±—ã—á–Ω–æ
                return true;
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–î–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç—å"
            document.getElementById('confirmBtn').addEventListener('click', function() {
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                notesField.value = '–ü—Ä–∏—Ö–æ–¥ —Å —É–ø–∞–∫–æ–≤–∫–∏';
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                notesModal.hide();
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
                shouldSubmit = true;
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
                form.submit();
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–µ—Ç"
            document.getElementById('cancelBtn').addEventListener('click', function() {
                notesModal.hide();
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ Notes
                setTimeout(() => {
                    notesField.focus();
                    notesField.select();
                }, 300); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
            document.getElementById('notesModal').addEventListener('hidden.bs.modal', function () {
                // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ Notes
                notesField.focus();
                notesField.select();
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
            const notesContainer = notesField.parentElement;
            const quickFillButton = document.createElement('button');
            quickFillButton.type = 'button';
            quickFillButton.className = 'btn btn-sm btn-outline-secondary mt-2';
            quickFillButton.textContent = 'üì¶ –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏';
            quickFillButton.addEventListener('click', function() {
                notesField.value = '–ü—Ä–∏—Ö–æ–¥ —Å —É–ø–∞–∫–æ–≤–∫–∏';
                notesField.focus();
            });
            notesContainer.appendChild(quickFillButton);
        });
    </script>
    
    <style>
        .form-text {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        #notesModal .modal-body {
            font-size: 1.1rem;
            padding: 1.5rem;
        }
        
        #notesModal .modal-footer {
            padding: 1rem 1.5rem;
        }
        
        #notesModal .btn {
            min-width: 100px;
        }
    </style>
}