@using ComplectGroup.Web.Models
@model ShippingViewModel

@{
    ViewData["Title"] = "–û—Ç–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–∞";
}

<div class="container mt-4" style="max-width: 700px;">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4>üì§ –û—Ç–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–∞</h4>
        </div>
        <div class="card-body">
            <form asp-action="Ship" method="post" id="shippingForm">
                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="alert alert-danger">
                        <div asp-validation-summary="All"></div>
                    </div>
                }

                <!-- –ö–û–ú–ü–õ–ï–ö–¢–ê–¶–ò–Ø -->
                <div class="mb-3">
                    <label asp-for="ComplectationId" class="form-label">1Ô∏è‚É£ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è</label>
                    <select asp-for="ComplectationId" class="form-select" id="complectationSelect" required>
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—é --</option>
                        @foreach (var complectation in Model.Complectations)
                        {
                            <option value="@complectation.Id" data-number="@complectation.Number">
                                @complectation.Number
                            </option>
                        }
                    </select>
                    <span asp-validation-for="ComplectationId" class="invalid-feedback"></span>
                </div>

                <!-- –ü–û–ó–ò–¶–ò–Ø (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ AJAX) -->
                <div class="mb-3">
                    <label asp-for="PositionId" class="form-label">2Ô∏è‚É£ –ü–æ–∑–∏—Ü–∏—è –∏–∑ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏</label>
                    <select asp-for="PositionId" class="form-select" id="positionSelect" required disabled>
                        <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—é --</option>
                    </select>
                    <span asp-validation-for="PositionId" class="invalid-feedback"></span>
                </div>

                <!-- –î–ï–¢–ê–õ–¨ (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –ø–æ–∑–∏—Ü–∏–∏) -->
                <div class="mb-3">
                    <label asp-for="PartId" class="form-label">3Ô∏è‚É£ –î–µ—Ç–∞–ª—å</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="partNameDisplay" 
                               placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é" readonly>
                        <input asp-for="PartId" type="hidden" id="partIdInput">
                    </div>
                    <span asp-validation-for="PartId" class="invalid-feedback"></span>
                </div>

                <!-- –ö–û–õ–ò–ß–ï–°–¢–í–û -->
                <div class="mb-3">
                    <label asp-for="Quantity" class="form-label">4Ô∏è‚É£ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç)</label>
                    <input asp-for="Quantity" type="number" class="form-control" 
                           min="1" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" required />
                    <small class="text-muted" id="availableQty"></small>
                    <span asp-validation-for="Quantity" class="invalid-feedback"></span>
                </div>

                <!-- –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø -->
                <div class="mb-3">
                    <label asp-for="Notes" class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                    <textarea asp-for="Notes" class="form-control" rows="3" id="notesTextarea"
                              placeholder="–ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ –ª–∏—Ü–æ, –∏ —Ç.–¥."></textarea>
                    <span asp-validation-for="Notes" class="invalid-feedback"></span>
                </div>

                <!-- –ö–ù–û–ü–ö–ò -->
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                        ‚úÖ –û—Ç–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä
                    </button>
                    <a asp-action="Index" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–π ---
            const complectationSelect = document.getElementById('complectationSelect');
            if (complectationSelect) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                const selectedValue = complectationSelect.value;
                
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ option –≤ –º–∞—Å—Å–∏–≤, –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ (–∑–∞–≥–æ–ª–æ–≤–æ—á–Ω–æ–≥–æ)
                const options = Array.from(complectationSelect.options);
                const firstOption = options[0]; // –ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–π –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π option
                const sortableOptions = options.slice(1); // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º option –ø–æ —á–∏—Å–ª–æ–≤–æ–π —á–∞—Å—Ç–∏ –Ω–æ–º–µ—Ä–∞
                sortableOptions.sort((a, b) => {
                    const numA = extractFirstNumber(a.text);
                    const numB = extractFirstNumber(b.text);
                    
                    // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —á–∏—Å–ª–∞–º
                    if (numA !== numB) {
                        return numA - numB;
                    }
                    
                    // –ï—Å–ª–∏ —á–∏—Å–ª–∞ —Ä–∞–≤–Ω—ã, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–æ–ª–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É
                    return a.text.localeCompare(b.text);
                });
                
                // –û—á–∏—â–∞–µ–º select –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                while (complectationSelect.firstChild) {
                    complectationSelect.removeChild(complectationSelect.firstChild);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—É—é –æ–ø—Ü–∏—é
                complectationSelect.appendChild(firstOption);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏
                sortableOptions.forEach(option => {
                    complectationSelect.appendChild(option);
                });
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                complectationSelect.value = selectedValue;
                
                console.log('–í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–π –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ —á–∏—Å–ª–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞
            function extractFirstNumber(text) {
                if (!text) return Infinity;
                
                // –ò—â–µ–º –ø–µ—Ä–≤—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ü–∏—Ñ—Ä
                const match = text.match(/\d+/);
                if (match) {
                    const num = parseInt(match[0], 10);
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —á–∏—Å–ª–æ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ–µ (–Ω–µ NaN –∏ –Ω–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ)
                    if (!isNaN(num) && num < 1000000) {
                        return num;
                    }
                }
                
                // –î–ª—è —Å—Ç—Ä–æ–∫ –±–µ–∑ —á–∏—Å–µ–ª –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ, 
                // —á—Ç–æ–±—ã –æ–Ω–∏ –æ–∫–∞–∑–∞–ª–∏—Å—å –≤ –∫–æ–Ω—Ü–µ —Å–ø–∏—Å–∫–∞
                return Infinity;
            }
            
            // --- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AJAX ---
            console.log('Ship.js loaded');
            const positionSelect = document.getElementById('positionSelect');
            const partNameDisplay = document.getElementById('partNameDisplay');
            const partIdInput = document.getElementById('partIdInput');
            const availableQtySpan = document.getElementById('availableQty');
            const submitBtn = document.getElementById('submitBtn');
            const quantityInput = document.querySelector('[name="Quantity"]');
            const notesTextarea = document.getElementById('notesTextarea');
            const shippingForm = document.getElementById('shippingForm');
            
            // –ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—é—Ç –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—é
            complectationSelect.addEventListener('change', async function () {
                const complectationId = this.value;
                
                // –û—á–∏—â–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏ –¥–µ—Ç–∞–ª—å
                positionSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é --</option>';
                partNameDisplay.value = '';
                partIdInput.value = '';
                submitBtn.disabled = true;
                
                if (!complectationId) {
                    positionSelect.disabled = true;
                    return;
                }
                
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ AJAX
                    const response = await fetch(`/warehouse/api/positions/${complectationId}`);
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∑–∏—Ü–∏–π');
                    
                    const positions = await response.json();
                    
                    if (positions.length === 0) {
                        positionSelect.innerHTML = '<option value="">–í –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π</option>';
                        positionSelect.disabled = true;
                        return;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –≤ select
                    positions.forEach(pos => {
                        const option = document.createElement('option');
                        option.value = pos.id;
                        option.textContent = pos.name;
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º partId –≤ dataset
                        option.dataset.partId = pos.partId;
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º partName –µ—Å–ª–∏ –µ—Å—Ç—å –≤ –æ—Ç–≤–µ—Ç–µ
                        if (pos.partName) {
                            option.dataset.partName = pos.partName;
                        }
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º availableQuantity –µ—Å–ª–∏ –µ—Å—Ç—å –≤ –æ—Ç–≤–µ—Ç–µ
                        if (pos.availableQuantity !== undefined) {
                            option.dataset.availableQuantity = pos.availableQuantity;
                        }
                        positionSelect.appendChild(option);
                    });
                    
                    positionSelect.disabled = false;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    positionSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</option>';
                    positionSelect.disabled = true;
                }
            });
            
            // –ö–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞—é—Ç –ø–æ–∑–∏—Ü–∏—é
            positionSelect.addEventListener('change', function () {
                const selectedOption = this.options[this.selectedIndex];
                
                if (!this.value) {
                    partNameDisplay.value = '';
                    partIdInput.value = '';
                    submitBtn.disabled = true;
                    availableQtySpan.textContent = '';
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º partId –∏–∑ dataset
                const partId = selectedOption.dataset.partId;
                if (!partId) {
                    console.error('PartId –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ dataset');
                    return;
                }
                partIdInput.value = partId;
                
                // –ü–æ–ª—É—á–∞–µ–º partName –∏–∑ dataset –∏–ª–∏ –ø–∞—Ä—Å–∏–º –∏–∑ —Ç–µ–∫—Å—Ç–∞
                let partName = selectedOption.dataset.partName;
                if (!partName) {
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –¥–µ—Ç–∞–ª–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ (–º–µ–∂–¥—É —Å–∫–æ–±–∫–∞–º–∏)
                    const positionText = selectedOption.textContent;
                    const match = positionText.match(/\] (.+?) \(/);
                    partName = match ? match[1] : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –¥–µ—Ç–∞–ª—å';
                }
                partNameDisplay.value = partName;
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ dataset –∏–ª–∏ –ø–∞—Ä—Å–∏–º –∏–∑ —Ç–µ–∫—Å—Ç–∞
                let availableQty = selectedOption.dataset.availableQuantity;
                if (!availableQty) {
                    const positionText = selectedOption.textContent;
                    const qtyMatch = positionText.match(/–∫–æ–ª-–≤–æ: (\d+)\)/);
                    availableQty = qtyMatch ? qtyMatch[1] : '?';
                }
                availableQtySpan.textContent = `–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –æ—Ç–≥—Ä—É–∑–∫–∏: ${availableQty} —à—Ç.`;
                
                submitBtn.disabled = false;
            });
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            if (quantityInput) {
                quantityInput.addEventListener('change', function () {
                    if (this.value && parseInt(this.value) > 0) {
                        submitBtn.disabled = !partIdInput.value;
                    } else {
                        submitBtn.disabled = true;
                    }
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ—á–∞–Ω–∏–π
            shippingForm.addEventListener('submit', function(event) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ª–∏ –ø–æ–ª–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–π
                if (!notesTextarea.value.trim()) {
                    // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏
                    const complectationOption = complectationSelect.options[complectationSelect.selectedIndex];
                    const complectationNumber = complectationOption.dataset.number || 
                                                complectationOption.textContent || 
                                                '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –Ω–æ–º–µ—Ä';
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
                    const now = new Date();
                    const formattedDate = now.toLocaleDateString('ru-RU');
                    const formattedTime = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                    
                    const defaultNote = `–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è: ‚Ññ ${complectationNumber}, –î–∞—Ç–∞: ${formattedDate}, –í—Ä–µ–º—è: ${formattedTime}`;
                    
                    // –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (confirm('–ü–æ–ª–µ "–ø—Ä–∏–º–µ—á–∞–Ω–∏–µ" –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?\n\n' + defaultNote)) {
                        notesTextarea.value = defaultNote;
                    } else {
                        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
                        event.preventDefault();
                        notesTextarea.focus();
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "–ø—Ä–∏–º–µ—á–∞–Ω–∏–µ" –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.');
                        return;
                    }
                }
            });
        });
    </script>
}